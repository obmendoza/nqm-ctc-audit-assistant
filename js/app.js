// Main application logic for CTC Audit Dashboard

function initializeEventListeners() {
      // Navigation items
    document.querySelectorAll('.nav-item').forEach((item, index) => {
              item.addEventListener('click', () => switchNavigation(index));
    });

    // Role buttons
    document.querySelectorAll('.role-btn').forEach(btn => {
              btn.addEventListener('click', () => switchRole(btn));
    });

    // Tab listeners
    attachTabListeners();
}

function switchNavigation(navIndex) {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => item.classList.remove('active'));
      navItems[navIndex].classList.add('active');

    const navMap = ['overview', 'conditions', 'income', 'assets', 'credit', 'property', 'compliance', 'fraud', 'activity'];
      currentTab = navMap[navIndex] || 'overview';
      renderMainContent();
}

function switchRole(btnElement) {
      document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
      btnElement.classList.add('active');
      currentRole = btnElement.dataset.role;
      showNotification('Viewing as: ' + currentRole.charAt(0).toUpperCase() + currentRole.slice(1), 'info');
}

function renderMainContent() {
      const mainContent = document.getElementById('mainContent');
      const tabs = document.getElementById('tabBar');

    switch(currentTab) {
      case 'overview':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderOverviewTab();
                    break;
      case 'conditions':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderConditionsTab();
                    break;
      case 'income':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderIncomeTab();
                    break;
      case 'assets':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderAssetsTab();
                    break;
      case 'credit':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderCreditTab();
                    break;
      case 'property':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderPropertyTab();
                    break;
      case 'compliance':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderComplianceTab();
                    break;
      case 'fraud':
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderFraudTab();
                    break;
      case 'activity':
                    tabs.innerHTML = '';
                    mainContent.innerHTML = renderActivityLog();
                    break;
      default:
                    tabs.innerHTML = renderTabBar(['Overview', 'Conditions', 'Income', 'Assets', 'Credit', 'Property', 'Compliance', 'Fraud']);
                    mainContent.innerHTML = renderOverviewTab();
    }

    attachTabListeners();
      attachButtonListeners();
      renderRightSidebar();
}

function renderTabBar(tabNames) {
      const tabMap = { 'Overview': 'overview', 'Conditions': 'conditions', 'Income': 'income', 'Assets': 'assets', 'Credit': 'credit', 'Property': 'property', 'Compliance': 'compliance', 'Fraud': 'fraud' };
      return tabNames.map(name => {
                const tabKey = tabMap[name] || name.toLowerCase();
                return `<div class="tab ${currentTab === tabKey ? 'active' : ''}" data-tab="${tabKey}">${name}</div>`;
      }).join('');
}

function attachTabListeners() {
      document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                              currentTab = tab.dataset.tab;
                              renderMainContent();
                });
      });
}

function attachButtonListeners() {
      document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', () => handleButtonClick(btn));
      });
}

function handleButtonClick(btn) {
      const action = btn.dataset.action;
      switch(action) {
        case 'view-condition':
                      showConditionDetails(btn.dataset.id);
                      break;
        case 'clear-condition':
                      updateConditionStatus(btn.dataset.id, 'Cleared');
                      showNotification('Condition cleared successfully', 'success');
                      renderMainContent();
                      break;
        case 'run-audit':
                      startAuditAgentSimulation();
                      showNotification('Audit agent simulation started', 'info');
                      break;
        case 'generate-report':
                      generateAuditReport();
                      break;
        case 'escalate':
                      showNotification('Escalation sent to processor', 'warning');
                      addActivityLog('Escalation', 'Manual escalation triggered by auditor');
                      break;
        default:
                      showNotification('Action: ' + action, 'info');
      }
}

// ============ RENDER FUNCTIONS ============

function renderOverviewTab() {
      const completion = calculateAuditCompletion();
      const checklist = auditData.auditChecklist;

    return `
        <div class="overview-grid">
                <div class="card">
                            <h3>Audit Progress</h3>
                                        <div class="progress-container">
                                                        <div class="progress-bar">
                                                                            <div class="progress-fill" style="width: ${completion}%"></div>
                                                                                            </div>
                                                                                                            <span class="progress-text">${completion}% Complete</span>
                                                                                                                        </div>
                                                                                                                                    <div class="audit-meta">
                                                                                                                                                    <p><strong>Status:</strong> <span class="badge ${getStatusClass(auditData.auditStatus)}">${auditData.auditStatus}</span></p>
                                                                                                                                                                    <p><strong>Days to Close:</strong> ${auditData.daysToClose}</p>
                                                                                                                                                                                    <p><strong>Target Close:</strong> ${formatDate(auditData.targetCloseDate)}</p>
                                                                                                                                                                                                    <p><strong>Auditor:</strong> ${auditData.auditor}</p>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                        
                                                                                                                                                                                                                                <div class="card">
                                                                                                                                                                                                                                            <h3>Checklist Summary</h3>
                                                                                                                                                                                                                                                        <div class="checklist-grid">
                                                                                                                                                                                                                                                                        <div class="checklist-item" onclick="currentTab='conditions'; renderMainContent();">
                                                                                                                                                                                                                                                                                            <span class="badge ${getStatusClass(checklist.conditions.status)}">Conditions</span>
                                                                                                                                                                                                                                                                                                                <span>${checklist.conditions.clearedCount} cleared, ${checklist.conditions.priorToDocsCount + checklist.conditions.priorToFundingCount} pending</span>
                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                <div class="checklist-item" onclick="currentTab='income'; renderMainContent();">
                                                                                                                                                                                                                                                                                                                                                                    <span class="badge ${getStatusClass(checklist.income.status)}">Income</span>
                                                                                                                                                                                                                                                                                                                                                                                        <span>${checklist.income.status}</span>
                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="checklist-item" onclick="currentTab='assets'; renderMainContent();">
                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="badge ${getStatusClass(checklist.assets.status)}">Assets</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span>${checklist.assets.status}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="checklist-item" onclick="currentTab='credit'; renderMainContent();">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="badge ${getStatusClass(checklist.credit.status)}">Credit</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span>${checklist.credit.status}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="checklist-item" onclick="currentTab='property'; renderMainContent();">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="badge ${getStatusClass(checklist.property.status)}">Property</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span>${checklist.property.status}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="checklist-item" onclick="currentTab='compliance'; renderMainContent();">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="badge ${getStatusClass(checklist.compliance.status)}">Compliance</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span>${checklist.compliance.status}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="checklist-item" onclick="currentTab='fraud'; renderMainContent();">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="badge ${getStatusClass(checklist.fraud.status)}">Fraud</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span>${checklist.fraud.status}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <h3>Key Metrics</h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="metrics-grid">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="metric-card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="metric-label">LTV</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="metric-value">${auditData.metrics.ltv}%</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="metric-sub">Max allowed: 80%</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="metric-card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="metric-label">DTI</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="metric-value">${auditData.metrics.dti}%</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="metric-sub">Overlay review if > 43%</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="metric-card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="metric-label">DSCR</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="metric-value">${auditData.metrics.dscr}x</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="metric-sub">Min required: 1.15x</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="metric-card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="metric-label">Reserves</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="metric-value">${auditData.metrics.reserves.current} / ${auditData.metrics.reserves.required} mo</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="metric-sub">Shortfall: ${auditData.metrics.reserves.required - auditData.metrics.reserves.current} months</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h3>Agent Findings</h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="findings-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ${auditData.agentFindings.map(f => `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="finding-item ${f.severity.toLowerCase()}" onclick="showFindingDetails(auditData.agentFindings[${auditData.agentFindings.indexOf(f)}])">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="badge ${getSeverityClass(f.severity)}">${f.severity}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="finding-text">${f.finding}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="finding-time">${getTimeAgo(f.timestamp)}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `).join('')}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    `;
}

function renderConditionsTab() {
      const conditions = auditData.auditChecklist.conditions;

    return `
        <div class="section-header">
                <h3>Conditions Tracking</h3>
                        <div class="section-stats">
                                    <span class="stat-badge">PTD: ${conditions.priorToDocsCount}</span>
                                                <span class="stat-badge">PTF: ${conditions.priorToFundingCount}</span>
                                                            <span class="stat-badge success">Cleared: ${conditions.clearedCount}</span>
                                                                        <span class="stat-badge">Waived: ${conditions.waivedCount}</span>
                                                                                </div>
                                                                                    </div>

                                                                                        <div class="conditions-table">
                                                                                                <div class="table-header">
                                                                                                            <span>ID</span>
                                                                                                                        <span>Type</span>
                                                                                                                                    <span>Category</span>
                                                                                                                                                <span>Description</span>
                                                                                                                                                            <span>Status</span>
                                                                                                                                                                        <span>Assigned</span>
                                                                                                                                                                                    <span>Actions</span>
                                                                                                                                                                                            </div>
                                                                                                                                                                                                    ${conditions.items.map(c => `
                                                                                                                                                                                                                <div class="table-row">
                                                                                                                                                                                                                                <span class="condition-id">${c.id}</span>
                                                                                                                                                                                                                                                <span>${c.type}</span>
                                                                                                                                                                                                                                                                <span>${c.category}</span>
                                                                                                                                                                                                                                                                                <span class="condition-desc">${c.description}</span>
                                                                                                                                                                                                                                                                                                <span><span class="badge ${getStatusClass(c.status)}">${c.status}</span></span>
                                                                                                                                                                                                                                                                                                                <span>${c.assignedTo}</span>
                                                                                                                                                                                                                                                                                                                                <span class="action-btns">
                                                                                                                                                                                                                                                                                                                                                    <button class="btn-sm" data-action="view-condition" data-id="${c.id}">View</button>
                                                                                                                                                                                                                                                                                                                                                                        ${c.status !== 'Cleared' && c.status !== 'Waived' ? `<button class="btn-sm btn-success" data-action="clear-condition" data-id="${c.id}">Clear</button>` : ''}
                                                                                                                                                                                                                                                                                                                                                                                        </span>
                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                            `).join('')}
                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                    `;
}

function renderIncomeTab() {
      const income = auditData.auditChecklist.income;

    return `
        <div class="section-header">
                <h3>Income Documentation Review</h3>
                        <span class="badge ${getStatusClass(income.status)}">${income.status}</span>
                            </div>

                                <div class="detail-grid">
                                        <div class="card">
                                                    <h4>Income Summary</h4>
                                                                <p><strong>Total Monthly Income:</strong> ${formatCurrency(income.totalMonthlyIncome)}</p>
                                                                            <p><strong>Documents Verified:</strong> ${income.documentsVerified ? 'Yes' : 'No'}</p>
                                                                                        <p><strong>Calculation Accurate:</strong> ${income.calculationAccurate ? 'Yes' : 'No'}</p>
                                                                                                </div>

                                                                                                        <div class="card">
                                                                                                                    <h4>Income Sources</h4>
                                                                                                                                <div class="source-list">
                                                                                                                                                ${income.sources.map(s => `
                                                                                                                                                                    <div class="source-item">
                                                                                                                                                                                            <span class="source-type">${s.type}</span>
                                                                                                                                                                                                                    <span class="source-amount">${formatCurrency(s.amount)}/mo</span>
                                                                                                                                                                                                                                            <span class="badge ${s.verified ? 'status-clear' : 'status-pending'}">${s.verified ? 'Verified' : 'Pending'}</span>
                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                `).join('')}
                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                            ${income.issues.length > 0 ? `
                                                                                                                                                                                                                                                                                                                <div class="card issues-card">
                                                                                                                                                                                                                                                                                                                        <h4>Issues</h4>
                                                                                                                                                                                                                                                                                                                                <ul>${income.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                        ` : ''}
                                                                                                                                                                                                                                                                                                                                            `;
}

function renderAssetsTab() {
      const assets = auditData.auditChecklist.assets;

    return `
        <div class="section-header">
                <h3>Asset Documentation Review</h3>
                        <span class="badge ${getStatusClass(assets.status)}">${assets.status}</span>
                            </div>

                                <div class="detail-grid">
                                        <div class="card">
                                                    <h4>Reserve Analysis</h4>
                                                                <p><strong>Total Reserves:</strong> ${formatCurrency(assets.totalReserves)}</p>
                                                                            <p><strong>Required Reserves:</strong> ${formatCurrency(assets.requiredReserves)}</p>
                                                                                        <p><strong>Shortfall:</strong> <span class="text-danger">${formatCurrency(assets.requiredReserves - assets.totalReserves)}</span></p>
                                                                                                    <p><strong>Reserves Verified:</strong> ${assets.reservesVerified ? 'Yes' : 'No'}</p>
                                                                                                                <p><strong>Sourcing:</strong> <span class="badge ${getStatusClass(assets.sourcing)}">${assets.sourcing}</span></p>
                                                                                                                
                                                                                                                            <div class="progress-container">
                                                                                                                                            <div class="progress-bar">
                                                                                                                                                                <div class="progress-fill ${assets.totalReserves < assets.requiredReserves ? 'warning' : ''}" style="width: ${Math.min(100, (assets.totalReserves / assets.requiredReserves) * 100)}%"></div>
                                                                                                                                                                                </div>
                                                                                                                                                                                                <span class="progress-text">${Math.round((assets.totalReserves / assets.requiredReserves) * 100)}% of required</span>
                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                    
                                                                                                                                                                                                                            <div class="card">
                                                                                                                                                                                                                                        <h4>Accounts</h4>
                                                                                                                                                                                                                                                    <div class="source-list">
                                                                                                                                                                                                                                                                    ${assets.accounts.map(a => `
                                                                                                                                                                                                                                                                                        <div class="source-item">
                                                                                                                                                                                                                                                                                                                <span class="source-type">${a.bank}</span>
                                                                                                                                                                                                                                                                                                                                        <span class="source-amount">${formatCurrency(a.balance)}</span>
                                                                                                                                                                                                                                                                                                                                                                <span class="badge ${a.verified ? 'status-clear' : 'status-pending'}">${a.verified ? 'Verified' : 'Pending'}</span>
                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                    `).join('')}
                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                ${assets.issues.length > 0 ? `
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card issues-card">
                                                                                                                                                                                                                                                                                                                                                                                                                                            <h4>Issues</h4>
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <ul>${assets.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                            ` : ''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                `;
}

function renderCreditTab() {
      const credit = auditData.auditChecklist.credit;

    return `
        <div class="section-header">
                <h3>Credit Review</h3>
                        <span class="badge ${getStatusClass(credit.status)}">${credit.status}</span>
                            </div>

                                <div class="detail-grid">
                                        <div class="card">
                                                    <h4>Credit Score</h4>
                                                                <div class="score-display">
                                                                                <div class="score-value">${credit.rePullScore}</div>
                                                                                                <div class="score-change ${credit.scoreChange >= 0 ? 'positive' : 'negative'}">${credit.scoreChange >= 0 ? '+' : ''}${credit.scoreChange}</div>
                                                                                                            </div>
                                                                                                                        <p><strong>Original Score:</strong> ${credit.originalScore}</p>
                                                                                                                                    <p><strong>Re-Pull Date:</strong> ${formatDate(credit.rePullDate)}</p>
                                                                                                                                            </div>
                                                                                                                                            
                                                                                                                                                    <div class="card">
                                                                                                                                                                <h4>Credit Activity</h4>
                                                                                                                                                                            <p><strong>New Tradelines:</strong> ${credit.newTradelines ? 'Yes' : 'None'}</p>
                                                                                                                                                                                        <p><strong>New Inquiries:</strong> ${credit.newInquiries}</p>
                                                                                                                                                                                                </div>
                                                                                                                                                                                                    </div>
                                                                                                                                                                                                    
                                                                                                                                                                                                        ${credit.issues.length > 0 ? `
                                                                                                                                                                                                            <div class="card issues-card">
                                                                                                                                                                                                                    <h4>Issues</h4>
                                                                                                                                                                                                                            <ul>${credit.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                    ` : '<div class="card success-card"><p>No credit issues identified.</p></div>'}
                                                                                                                                                                                                                                        `;
}

function renderPropertyTab() {
      const property = auditData.auditChecklist.property;

    return `
        <div class="section-header">
                <h3>Property / Title / Insurance</h3>
                        <span class="badge ${getStatusClass(property.status)}">${property.status}</span>
                            </div>

                                <div class="detail-grid">
                                        <div class="card">
                                                    <h4>Appraisal</h4>
                                                                <p><strong>Review Status:</strong> <span class="badge ${getStatusClass(property.appraisalReview)}">${property.appraisalReview}</span></p>
                                                                            <p><strong>Appraisal Date:</strong> ${formatDate(property.appraisalDate)}</p>
                                                                                    </div>

                                                                                            <div class="card">
                                                                                                        <h4>Title</h4>
                                                                                                                    <p><strong>Review Status:</strong> <span class="badge ${getStatusClass(property.titleReview)}">${property.titleReview}</span></p>
                                                                                                                                <p><strong>Order Date:</strong> ${formatDate(property.titleOrderDate)}</p>
                                                                                                                                        </div>
                                                                                                                                        
                                                                                                                                                <div class="card">
                                                                                                                                                            <h4>Insurance</h4>
                                                                                                                                                                        <p><strong>Binder Status:</strong> <span class="badge ${getStatusClass(property.insuranceBinder)}">${property.insuranceBinder}</span></p>
                                                                                                                                                                                    <p><strong>Order Date:</strong> ${formatDate(property.insuranceOrderDate)}</p>
                                                                                                                                                                                            </div>
                                                                                                                                                                                                </div>
                                                                                                                                                                                                
                                                                                                                                                                                                    ${property.issues.length > 0 ? `
                                                                                                                                                                                                        <div class="card issues-card">
                                                                                                                                                                                                                <h4>Issues</h4>
                                                                                                                                                                                                                        <ul>${property.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                ` : ''}
                                                                                                                                                                                                                                    `;
}

function renderComplianceTab() {
      const compliance = auditData.auditChecklist.compliance;

    return `
        <div class="section-header">
                <h3>Compliance Check</h3>
                        <span class="badge ${getStatusClass(compliance.status)}">${compliance.status}</span>
                            </div>

                                <div class="detail-grid">
                                        <div class="card">
                                                    <h4>TRID / Closing Disclosure</h4>
                                                                <p><strong>TRID Status:</strong> <span class="badge ${getStatusClass(compliance.trid)}">${compliance.trid}</span></p>
                                                                            <p><strong>CD Issued:</strong> ${compliance.cdIssued ? 'Yes' : 'No'}</p>
                                                                                        <p><strong>CD Issued Date:</strong> ${formatDate(compliance.cdIssuedDate)}</p>
                                                                                                    <p><strong>CD Version:</strong> ${compliance.cdVersion}</p>
                                                                                                            </div>
                                                                                                            
                                                                                                                    <div class="card">
                                                                                                                                <h4>Regulatory</h4>
                                                                                                                                            <p><strong>ATR/QM:</strong> <span class="badge ${getStatusClass(compliance.atr)}">${compliance.atr}</span></p>
                                                                                                                                                        <p><strong>Fee Tolerance:</strong> <span class="badge ${getStatusClass(compliance.feeTolerance)}">${compliance.feeTolerance}</span></p>
                                                                                                                                                                    <p><strong>Fee Variance:</strong> $${compliance.feeVariance} under tolerance</p>
                                                                                                                                                                                <p><strong>State Requirements:</strong> <span class="badge ${getStatusClass(compliance.stateRequirements)}">${compliance.stateRequirements}</span></p>
                                                                                                                                                                                        </div>
                                                                                                                                                                                            </div>
                                                                                                                                                                                            
                                                                                                                                                                                                ${compliance.issues.length > 0 ? `
                                                                                                                                                                                                    <div class="card issues-card">
                                                                                                                                                                                                            <h4>Issues</h4>
                                                                                                                                                                                                                    <ul>${compliance.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                            ` : '<div class="card success-card"><p>All compliance checks passed.</p></div>'}
                                                                                                                                                                                                                                `;
}

function renderFraudTab() {
      const fraud = auditData.auditChecklist.fraud;

    return `
        <div class="section-header">
                <h3>Fraud Detection</h3>
                        <span class="badge ${getStatusClass(fraud.status)}">${fraud.status}</span>
                            </div>

                                <div class="detail-grid">
                                        <div class="card">
                                                    <h4>Risk Assessment</h4>
                                                                <div class="risk-display">
                                                                                <div class="risk-score">${fraud.riskScore}</div>
                                                                                                <div class="risk-label ${fraud.riskLevel.toLowerCase()}">${fraud.riskLevel} Risk</div>
                                                                                                            </div>
                                                                                                                        <div class="progress-container">
                                                                                                                                        <div class="progress-bar">
                                                                                                                                                            <div class="progress-fill ${fraud.riskScore > 50 ? 'danger' : fraud.riskScore > 25 ? 'warning' : 'success'}" style="width: ${fraud.riskScore}%"></div>
                                                                                                                                                                            </div>
                                                                                                                                                                                        </div>
                                                                                                                                                                                                </div>
                                                                                                                                                                                                
                                                                                                                                                                                                        <div class="card">
                                                                                                                                                                                                                    <h4>Verification Checks</h4>
                                                                                                                                                                                                                                <div class="check-list">
                                                                                                                                                                                                                                                ${fraud.checks.map(c => `
                                                                                                                                                                                                                                                                    <div class="check-item">
                                                                                                                                                                                                                                                                                            <span class="check-name">${c.name}</span>
                                                                                                                                                                                                                                                                                                                    <span class="badge ${c.status === 'Pass' ? 'status-clear' : 'status-review'}">${c.status}</span>
                                                                                                                                                                                                                                                                                                                                            <span class="confidence">${c.confidence}%</span>
                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                `).join('')}
                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                            ${fraud.flags.length > 0 ? `
                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card issues-card">
                                                                                                                                                                                                                                                                                                                                                                                                                        <h4>Flags</h4>
                                                                                                                                                                                                                                                                                                                                                                                                                                <ul>${fraud.flags.map(f => `<li>${f}</li>`).join('')}</ul>
                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                        ` : '<div class="card success-card"><p>No fraud flags detected.</p></div>'}
                                                                                                                                                                                                                                                                                                                                                                                                                                            `;
}

function renderActivityLog() {
      return `
          <div class="section-header">
                  <h3>Agent Activity Log</h3>
                      </div>
                          <div class="activity-log">
                                  ${auditData.activityLog.length > 0 ? auditData.activityLog.map(entry => `
                                              <div class="activity-entry">
                                                              <span class="activity-time">${entry.timestamp}</span>
                                                                              <span class="activity-title">${entry.title}</span>
                                                                                              <span class="activity-desc">${entry.description}</span>
                                                                                                          </div>
                                                                                                                  `).join('') : '<p class="empty-state">No activity logged yet.</p>'}
                                                                                                                      </div>
                                                                                                                          `;
}

function renderRightSidebar() {
      const sidebar = document.getElementById('rightSidebar');
      if (!sidebar) return;

    const findings = auditData.agentFindings;
      const criticalFindings = findings.filter(f => f.severity === 'Critical');
      const warningFindings = findings.filter(f => f.severity === 'Warning');

    sidebar.innerHTML = `
            <div class="sidebar-section">
                        <h4 class="sidebar-title">Agent Highlights</h4>
                                    ${findings.map(f => `
                                                    <div class="highlight-item">
                                                                        <strong>${f.category} Agent:</strong> ${f.recommendation}
                                                                                        </div>
                                                                                                    `).join('')}
                                                                                                            </div>
                                                                                                            
                                                                                                                    <div class="sidebar-section">
                                                                                                                                <h4 class="sidebar-title alerts">Alerts & Issues</h4>
                                                                                                                                            ${criticalFindings.map(f => `<div class="alert-item critical">${f.finding}</div>`).join('')}
                                                                                                                                                        ${warningFindings.map(f => `<div class="alert-item warning">${f.finding}</div>`).join('')}
                                                                                                                                                                    ${auditData.auditChecklist.property.issues.map(i => `<div class="alert-item warning">${i}</div>`).join('')}
                                                                                                                                                                            </div>
                                                                                                                                                                            
                                                                                                                                                                                    <div class="sidebar-section">
                                                                                                                                                                                                <h4 class="sidebar-title">Quick Actions</h4>
                                                                                                                                                                                                            <button class="action-btn" data-action="run-audit">Run Audit Agent</button>
                                                                                                                                                                                                                        <button class="action-btn" data-action="escalate">Escalate to Processor</button>
                                                                                                                                                                                                                                    <button class="action-btn" data-action="generate-report">Generate Audit Report</button>
                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                `;

    // Re-attach button listeners for sidebar
    sidebar.querySelectorAll('[data-action]').forEach(btn => {
              btn.addEventListener('click', () => handleButtonClick(btn));
    });
}

function generateAuditReport() {
      const completion = calculateAuditCompletion();
      const content = `
              <div class="report-content">
                          <h4>CTC Audit Report</h4>
                                      <p><strong>Loan:</strong> ${auditData.loanNumber}</p>
                                                  <p><strong>Borrowers:</strong> ${auditData.borrowers}</p>
                                                              <p><strong>Program:</strong> ${auditData.program}</p>
                                                                          <p><strong>Audit Completion:</strong> ${completion}%</p>
                                                                                      <p><strong>Status:</strong> ${auditData.auditStatus}</p>
                                                                                                  <hr>
                                                                                                              <h4>Section Summary</h4>
                                                                                                                          <p>Conditions: ${auditData.auditChecklist.conditions.status}</p>
                                                                                                                                      <p>Income: ${auditData.auditChecklist.income.status}</p>
                                                                                                                                                  <p>Assets: ${auditData.auditChecklist.assets.status}</p>
                                                                                                                                                              <p>Credit: ${auditData.auditChecklist.credit.status}</p>
                                                                                                                                                                          <p>Property: ${auditData.auditChecklist.property.status}</p>
                                                                                                                                                                                      <p>Compliance: ${auditData.auditChecklist.compliance.status}</p>
                                                                                                                                                                                                  <p>Fraud: ${auditData.auditChecklist.fraud.status}</p>
                                                                                                                                                                                                              <hr>
                                                                                                                                                                                                                          <h4>Outstanding Issues</h4>
                                                                                                                                                                                                                                      ${auditData.agentFindings.filter(f => f.severity === 'Critical' || f.severity === 'Warning').map(f => `<p><strong>${f.severity}:</strong> ${f.finding}</p>`).join('')}
                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                  `;
      openModal('Audit Report', content);
      addActivityLog('Report Generated', 'CTC Audit Report generated by auditor');
}
